# 文件名: prompt_ui.txt (V15.0)

## 二、 网页管理端 (AdFlowPro_UI)

Web界面是系统的控制中心，提供给测试人员或管理员使用，核心是实现“所见即所得”的测试流程编排。

### 1. 设备与应用管理

- **设备管理 (`/devices`)**: 提供设备列表和详情页，支持状态查看、名称编辑、快捷操作（亮/息屏）、应用列表查看、远程卸载等。
- **主应用目录 (`/apps`)**: 集中管理公司所有目标App。支持对应用记录的增删改查，并集成APK的**拉取归档**和**分发部署**的完整流程。

### 2. 测试资产管理 (核心可视化编排)

- **统一入口**: 在侧边栏提供“测试资产”主菜单，下设“原子操作”、“测试包”、“测试用例”、“测试套件”四个子菜单。
- **原子操作编辑器**:

  - **高效布局**: 采用紧凑的栅格布局，信息密度高，减少滚动。
  - **分类管理**:
    - 支持为原子操作选择一个已有的分类。
    - **即时创建**: 在下拉框中直接输入新名称并回车，即可快速创建新分类，无需离开当前页面。
  - **场景定义区**: 支持选择“UI元素”或“OCR文本”，配置多条件组合匹配（包含/排除），并能为主匹配器设置**锚点策略**（第一个/最后一个）。
  - **动作定义区**: 通过**拖拽**方式，编排一系列丰富的响应动作，涵盖**UI交互**、**流程控制**（固定/动态等待、焦点守护、结束用例）、**数据交互**（上报提取值）、**设备控制**以及**断言** (`assert_element_exists`, `assert_text_equals`)。
  - 支持配置原子操作的**优先级 (Priority)**，数值越小，优先级越高。
  - **循环控制**: 支持配置“最大执行次数”，允许一个原子操作在满足条件时被重复触发执行。
  - **流程穿透**: 支持配置“匹配成功后继续扫描”开关，允许将多个原子操作串联成一个不间断的执行序列。
  - **强大的主匹配器配置**:
    - **多文本输入**: 使用**自定义标签输入组件 (`MultiTextInput`)**，允许为单个匹配条件配置多个备选文本，以应对UI上的细微文本变化。
    - **屏幕区域选择器**: 提供一个**可视化的九宫格组件 (`ScreenRegionSelector`)**，允许用户将匹配范围限定在屏幕的特定区域（如“右上角”），并支持横竖屏切换模拟。
    - **空间关系配置**: 提供一个独立的配置区，允许用户定义主匹配器与另一个“锚点元素”之间的空间关系（如“在...的右侧”）。
  - **高效的次级匹配器**: 次级匹配器的UI被简化，专注于定义场景的“包含”或“排除”文本条件，以实现最快的场景验证速度。
  - **原子操作列表页**:
    - **分类筛选**: 提供下拉框，可按分类快速筛选原子操作列表。
    - **分类展示**: 表格中新增“分类”列，清晰展示每个原子操作的归属。
    - **ID展示**: 移除了无意义的“序号”列，替换为唯一的、可排序的“ID”列。

  - **测试包/用例/套件编辑器**:
    - 均采用**双栏拖拽布局**，提供高度一致的用户体验。
    - **左侧**: 作为“资源池”，展示下一层级的可用资产。
    - **右侧**: 作为“构建区”，用户从左侧拖入资产，并可在构建区内部**拖拽排序**，定义执行流程。
    - **防重复机制**: 在资源池中，已被拖入构建区的项将被禁用或隐藏，防止重复添加。
    - **执行参数配置**:
      - **测试用例编辑器**: 提供“用例总超时(秒)”的输入框，并带有前端校验（如不小于5秒）。
      - **测试套件编辑器**: 提供“执行参数”配置区，包含“失焦守护超时(秒)”、“无动作后固定延迟(ms)”、“动作后固定延迟(ms)”和“失败截图质量”四个配置项，均带有默认值和校验规则。
  - **图元模板管理页面 (`/image-templates`)**:
    - **双视图模式**: 支持以**表格**（用于查看详细元数据）和**网格**（用于快速视觉浏览）两种模式展示图元库。
    - **灵活的UI控制**: 在网格模式下，提供一个**尺寸滑块**来动态调整预览图的大小（大/中/小），优化浏览体验。
    - **高效工作流**: 支持**从剪贴板直接粘贴图片 (Ctrl+V)** 进行上传，并提供明确的UI提示，极大提升了用户操作效率。
  - **分层匹配器UI**: 彻底重构了主匹配器的UI，使其逻辑与后端模型完全对应：
    1.  顶层提供 **[文本] / [图元]** 单选框。
    2.  仅当选择 **[文本]** 时，才会出现下一级的 **[UI元素] / [OCR文本]** 单选框。
    3.  根据用户的选择，通过**动态组件**加载对应的 `TextMatcherEditor.vue` 或 `ImageMatcherEditor.vue`，界面清爽，职责单一。
    4.  **智能状态清理**: 当用户切换匹配类型时，表单状态中不相关的字段会被自动清除，确保了数据的纯净性。
  - **<!-- 新增 -->双模双复杂度图元匹配UI**:

    - **模式选择**: `ImageMatcherEditor`组件提供了“像素匹配”和“特征点匹配”的明确选项。
    - **高级算法开关**: 提供了一个“高级算法”开关，并配有动态提示，清晰地告知用户启用后将执行更强大但可能更慢的算法（多尺度或多目标聚类）。
    - **智能UI**: `匹配阈值`滑块仅在“像素匹配”模式下显示，避免了在不适用的ORB模式下对用户造成困扰。`多目标策略`选择器则在两种模式下均可用。

  - **增强的图元选择工作流**:
    - **组件化**: 将图元库的管理和浏览功能完全封装到一个可复用的`ImageTemplateBrowser.vue`组件中。
    - **一体化体验**: 在原子操作编辑器中选择图元时弹出的对话框，现在**内置了完整的上传、编辑、删除功能**，用户无需离开当前流程即可完成图元资产的整个生命周期管理。
    - **异步URL加载**: 为优化性能和简化后端逻辑，图元预览图的`publicUrl`现在通过**独立的异步API请求**获取，实现了UI渲染和数据获取的解耦。

### 2.5. 原子操作分类管理 (`/platform-settings/atom-categories`)
   - **独立管理页面**: 提供一个专门的页面，用于对所有原子操作分类进行增、删、改、查。
   - **依赖保护**: 在删除分类时，系统会检查该分类是否仍被原子操作使用。如果被使用，则禁止删除并给出明确提示，保证了资产的完整性。

### 3. 设备远程交互

- **通用动作序列编辑器 (`ActionSequenceEditor.vue`)**:
  - **组件统一**: 创建了一个**可复用的 `ActionSequenceEditor.vue` 组件**，它取代了旧的 `ActionEditorRow` 和 `CommandForm`，统一了动作编辑和执行的UI。
  - **双模式 (Dual Mode)**:
    - `editor` 模式: 用于原子操作编辑器，提供完整的编辑、拖拽排序、删除和**序列实时测试**功能。
    - `standalone` 模式: 用于设备详情页，提供一个轻量级的界面，用于构建和执行临时的动作序列。
  - **实时序列测试**: 在原子操作编辑器中，用户可以点击“测试序列”按钮，选择一个在线设备，**立即执行当前编排的完整动作列表**，并实时看到最终的执行结果（成功或失败），极大地缩短了调试反馈链路。
  - **智能参数UI**: 组件内的每一行 (`ActionRow.vue`) 都会根据所选的动作类型，**自动显示或隐藏**其所需的参数输入框，保持界面整洁。
  - **健壮的结果获取**: 通过**HTTP轮询**机制获取实时测试的结果，保证了交互的稳定可靠。
- **全局实时状态栏 (`StatusBar.vue`)**:
  - **UI呈现**: 在应用底部新增了一个全局的状态栏，默认隐藏。
  - **功能**:
    - 它是所有异步操作结果的**统一出口**。
    - 用户可以通过点击顶部导航栏的新增开关，**一键显示或隐藏**此面板。
    - **上下文快速编辑**: 在测试套件、测试用例、测试包和流程图编辑器中，为引用的子资产（如用例、包、原子操作）提供了快捷“编辑”按钮，点击后可在新标签页中直接打开对应的编辑器，极大地提升了跨层级维护的效率。
    - 面板高度可以通过**拖拽**自由调整。
- **多维度实时测试**:
  - **实时匹配器验证**: 在“触发条件”卡片中新增“测试此条件”按钮。
  - **实时原子操作测试**: 在“基础信息”卡片中新增“测试此原子操作”按钮。
  - **实时结果反馈**: 所有实时测试的结果都会被推送到全局的状态栏中。
- **通信架构升级**:
  - **WebSocket Store**: `webSocketStore.ts`作为UI与服务器之间**持久化WebSocket连接**的管理中心，现在还包含了**自动重连**逻辑。
  - **服务激活**: `wsService.ts`成为所有实时指令发送的统一API层。
- **事件驱动的数据刷新**:
  - **设备详情页**: 手动触发的“截图”、“获取UI结构”、“更新应用列表”等操作，其结果展示已从**定时等待**升级为由**WebSocket事件驱动的实时刷新**。
  - **主应用目录**: “拉取APK”操作的完成状态，现在也通过实时事件通知并触发列表自动刷新。
- **“即发即忘”式实时测试**: 所有实时测试功能（匹配器、动作序列、完整原子操作）的交互流程，已从**阻塞式的对话框轮询**，全面重构为**“即发即忘”**模式。用户点击测试后可立即关闭对话框，所有结果均通过全局状态栏异步呈现，体验流畅。
- **交互式屏幕预览**: 设备详情页的截图预览器已升级为强大的远程控制和分析工具：
  - **单击即Tap**: 在截图上单击，会立即向设备对应坐标发送`tap`指令。
  - **长按预览**: 长按图片则会触发传统的全屏放大预览。
  - **九宫格辅助线**: 卡片头部提供了开关，可一键在截图上叠加/隐藏九宫格参考线，方便用户配置屏幕区域匹配。
  - **一键保存**: 提供了明确的“保存”按钮。
- **远程调试控制面板**:
  - **位置**: 在设备详情页（`DeviceDetailPage.vue`）的显著位置（如“快捷操作”卡片内或独立卡片）。
  - **UI组件**:
      1.  一个主开关 (`el-switch`)，用于控制“调试模式”的全局开启与关闭。
      2.  一个多选框组 (`el-select` 并设置 `multiple`)，在主开关开启时才可用。该多选框的选项列表为固定的 TAG 字符串（如 `EXECUTOR`, `MATCHER` 等）。
  - **交互逻辑**:
      1.  页面加载时，通过 `GET` 接口获取并回显设备当前的调试配置。
      2.  当用户操作开关或修改 TAG 选择时，立即调用 `POST` 接口，将**最新的完整配置**（开关状态 + TAG列表）发送给后端。

### 4. 测试任务与报告

- **启动测试弹窗**: 在“测试套件”列表页提供“运行”按钮。点击后弹出对话框，让用户选择目标App和设备来创建任务。
- **任务历史 (`/jobs`)**:
  - 展示所有已创建的测试任务列表及其最终状态。
  - **任务队列支持**:
    - 能够以不同颜色（如黄色）的标签清晰展示`queued`（排队中）状态。
    - 筛选器支持按`queued`状态和**目标设备**进行筛选。
    - 为处于`queued`状态的任务提供“取消排队”按钮。
  - 为处于`running`状态的任务提供“停止”按钮，允许用户远程中断测试。
  - 提供**自动刷新**开关，方便用户实时监控任务队列变化。
- **任务详情页 (`/jobs/{job_id}`)**:
  - 以时间线或步骤列表的形式，实时更新并展示该任务的详细执行过程。
  - **动态标题**: 标签页标题会动态显示任务ID（如“任务详情 - #123”）。
  - 每一行展示一个执行步骤，包含其状态、耗时、日志。
  - 支持点击查看该步骤关联的**屏幕截图**，实现问题可追溯。
  - **增强失败展示**: 对于因**断言失败**的步骤，将额外清晰地展示**期望值**与从设备上报的**实际值**，帮助用户快速定位问题根源。
  - 如果任务正在运行或排队中，同样提供“停止”或“取消排队”按钮。
  - **失败上下文展示**: 对于失败的步骤，如果App端上报了UI或OCR的上下文数据，将通过一个**可折叠的面板**来展示格式化后的JSON数据，帮助用户快速分析失败原因。
- **报告导出**:
  - 在任务历史页和详情页，为已完成的任务提供“导出报告”按钮。
  - 点击后，通过调用后端API，触发一个自包含HTML报告的下载。

### 5. 核心界面架构 (Core UI Architecture)

- **多标签页模式 (已实现)**:
  - **高效工作流**: 系统采用专业的多标签页界面，允许用户同时打开设备详情、资产编辑器、任务列表等多个页面，并通过标签页栏进行快速切换。
  - **状态保持**: 切换标签页时，利用`<keep-alive>`技术保持页面的完整状态（包括表单数据、滚动位置等），避免了因页面切换导致的工作中断和数据丢失。
  - **动态标题**: 标签页的标题能够根据页面内容动态更新（例如，从“编辑原子操作”变为“编辑 - 点击登录按钮”），为用户提供清晰的上下文导航。
  - **统一管理**: 通过集中的`tabStore`管理所有标签页的生命周期，包括添加、激活、移除等。
- **全局状态指示器**:
  - **实时状态显示**: 顶部导航栏新增了一个**WebSocket连接状态指示器**，能通过不同的图标和颜色实时展示“已连接”、“连接中”、“已断开”三种状态。
  - **交互式重连**: 当连接断开时，用户可**点击该图标手动触发重连**，增强了用户对系统状态的控制力。
